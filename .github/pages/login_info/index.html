<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<meta name="darkreader-lock" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta property="og:title" content="fount Credentials Manager" />
	<meta property="og:type" content="website" />
	<meta property="og:description" content="A secure space for managing your fount login credentials—the keys to your world of untold stories." />
	<meta name="description" content="A secure space for managing your fount login credentials—the keys to your world of untold stories." />
	<meta property="og:image" content="https://repository-images.githubusercontent.com/862251163/0ac90205-ae40-4fc6-af67-1e28d074c76b" />
	<link rel="icon" type="image/svg+xml" href="https://steve02081504.github.io/fount/imgs/icon.svg" />
	<title data-i18n="login_info.title"></title>
	<script blocking="render" type="module" src="../preload.mjs"></script>
	<link href="https://cdn.jsdelivr.net/npm/daisyui/themes.css" rel="stylesheet" type="text/css" crossorigin="anonymous" />
	<link href="https://cdn.jsdelivr.net/npm/daisyui/daisyui.css" rel="stylesheet" type="text/css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="../base.css" type="text/css" />
	<script type="module">
		import '../base.mjs'
		import { transferEncryptedCredentials, receiveAndValidateEncryptedCredentials } from '../scripts/credentialManager.mjs'
		import { initTranslations, geti18n } from '../scripts/i18n.mjs'
		/* global urlParams */
		await initTranslations('login_info')
		const hashParams = new URLSearchParams(window.location.hash.substring(1))
		const uuid = hashParams.get('uuid')
		const redirectUrl = urlParams.get('redirect')
		// Get fileId and from from hash params for security (not sent to server)
		const fileId = hashParams.get('fileId')
		const from = hashParams.get('from')
		const errorModal = document.getElementById('error_modal')
		const errorMessageElement = document.getElementById('error_modal_message')
		const ignoreBtn = document.getElementById('ignore_and_continue_btn')
		const retryBtn = document.getElementById('retry_btn')

		/**
		 * 显示错误弹窗。
		 * @param {string} message - 错误信息。
		 * @param {Object} [options] - 选项。
		 * @param {() => void} [options.onIgnore] - 点击忽略时的回调。
		 * @param {() => void} [options.onRetry] - 点击重试时的回调。
		 */
		function showErrorModal(message, {
			onIgnore,
			/**
			 * 默认重试回调函数。
			 * @returns {void}
			 */
			onRetry = () => {
				errorModal.close()
				window.location.reload()
			}
		} = {}) {
			errorMessageElement.textContent = message
			ignoreBtn.onclick = onIgnore
			retryBtn.onclick = onRetry
			errorModal.showModal()
		}

		try {
			if (!redirectUrl || !uuid) {
				errorMessageElement.textContent = geti18n('login_info.modal.missing_params')
				throw new Error('Missing redirect or uuid')
			}
			const instanceId = uuid.split('-')[0]
			if (fileId || from) try { // save
				const encryptedData = await receiveAndValidateEncryptedCredentials(fileId, from, hashParams, uuid)
				localStorage.setItem(`fount-login-${instanceId}`, encryptedData)
				const targetUrl = new URL(decodeURIComponent(redirectUrl))
				if (urlParams.has('forward')) {
					const newHashParams = new URLSearchParams()
					if (fileId) newHashParams.set('fileId', fileId)
					if (from) newHashParams.set('from', from)
					targetUrl.hash = newHashParams.toString()
				}
				window.location.href = targetUrl.href
			} catch (error) {
				console.error('Failed to receive credentials:', error)
				errorMessageElement.textContent = geti18n('login_info.modal.retrieve_error', { error: error.message })
				throw error
			}
			else if (localStorage.getItem(`fount-login-${instanceId}`)) try {// load
				await transferEncryptedCredentials(uuid, redirectUrl)
			} catch (error) {
				console.error('Failed to transfer credentials:', error)
				errorMessageElement.textContent = geti18n('login_info.modal.transfer_error', { error: error.message })
				throw error
			}
			else {
				console.error('No credentials found.')
				errorMessageElement.textContent = geti18n('login_info.modal.no_credentials')
				throw new Error('No credentials found.')
			}
		}
		catch (error) {
			showErrorModal(errorMessageElement.textContent || error.message, {
				/**
				 * 默认忽略回调函数。
				 * @returns {void}
				 */
				onIgnore: () => {
					errorModal.close()
					if (!redirectUrl) return window.location.reload()
					const targetUrl = new URL(decodeURIComponent(redirectUrl))
					targetUrl.searchParams.set('login_status', 'failed')
					targetUrl.searchParams.set('reason', error.message)
					window.location.href = targetUrl.href
				}
			})
		}
	</script>
</head>

<body class="flex justify-center items-center h-screen">
	<span class="loading loading-ring loading-lg"></span>

	<dialog id="error_modal" class="modal">
		<div class="modal-box">
			<h3 class="font-bold text-lg" data-i18n="login_info.modal.title"></h3>
			<p class="py-4" id="error_modal_message"></p>
			<div class="modal-action">
				<button class="btn" id="ignore_and_continue_btn" data-i18n="login_info.modal.buttons.ignore"></button>
				<button class="btn btn-primary" id="retry_btn" data-i18n="login_info.modal.buttons.retry"></button>
			</div>
		</div>
	</dialog>
</body>

</html>
