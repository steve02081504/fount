<!DOCTYPE html>
<html data-theme="dark">

<head>
	<meta charset="UTF-8">
	<meta name="darkreader-lock">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta property="og:title" content="fount Credentials Manager" />
	<meta property="og:type" content="website" />
	<meta property="og:description" content="A page for securely managing your fount login credentials." />
	<meta property="og:image" content="https://repository-images.githubusercontent.com/862251163/0ac90205-ae40-4fc6-af67-1e28d074c76b">
	<link rel="icon" type="image/svg+xml" href="https://steve02081504.github.io/fount/imgs/icon.svg">
	<title>fount!</title>
	<link href="https://cdn.jsdelivr.net/npm/daisyui/themes.css" rel="stylesheet" type="text/css" crossorigin="anonymous" />
	<link href="https://cdn.jsdelivr.net/npm/daisyui/daisyui.css" rel="stylesheet" type="text/css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/@unocss/runtime" crossorigin="anonymous"></script>
	<script blocking="render" type="module" src="../preload.mjs"></script>
	<link rel="stylesheet" href="../base.css" type="text/css">
	<script type="module" src="../base.mjs"></script>
	<script type="module">
		import { uploadToCatbox } from '../scripts/catbox.mjs'
		import { encrypt, decrypt } from '../scripts/crypto.mjs'

		(async () => {
			/* global urlParams */
			const hashParams = new URLSearchParams(window.location.hash.substring(1))
			const uuid = hashParams.get('uuid')
			const redirectUrl = urlParams.get('redirect')
			const fileId = urlParams.get('fileId')
			const from = urlParams.get('from')

			if (!uuid || !redirectUrl) {
				console.error('Missing uuid from hash or redirectUrl from query')
				return
			}

			let plaintextCredentials = null // This will be a JSON string

			try {
				if (fileId) { // From Catbox link
					const resp = await fetch(`https://litter.catbox.moe/${fileId}`)
					if (!resp.ok) throw new Error(`Failed to fetch credentials from file: ${resp.statusText}`)
					const encryptedData = await resp.text()
					plaintextCredentials = await decrypt(encryptedData, uuid) // Decrypts to a JSON string
				}
				else if (from === 'clipboard_encrypted') { // From login page (encrypted)
					const encryptedData = await navigator.clipboard.readText()
					plaintextCredentials = await decrypt(encryptedData, uuid)
				}
				else { // Fallback: from URL hash
					const encryptedFromHash = hashParams.get('encrypted_creds')
					if (encryptedFromHash)
						plaintextCredentials = await decrypt(decodeURIComponent(encryptedFromHash), uuid)
				}
			}
			catch (e) {
				console.error('Failed to obtain credentials:', e)
			}

			if (plaintextCredentials) { // Save mode: save PLAINTEXT to localStorage
				localStorage.setItem(`fount-login-${uuid}`, plaintextCredentials)
				window.location.href = decodeURIComponent(redirectUrl)
			}
			else { // Load mode: load plaintext, encrypt, then transfer securely
				const storedPlaintext = localStorage.getItem(`fount-login-${uuid}`)
				const targetUrl = new URL(decodeURIComponent(redirectUrl))

				if (storedPlaintext)
					try {
						const encryptedData = await encrypt(storedPlaintext, uuid)
						const targetHashParams = new URLSearchParams(targetUrl.hash.substring(1))
						targetHashParams.set('uuid', uuid) // Pass UUID via hash

						// 1. Try to use clipboard
						try {
							await navigator.clipboard.writeText(encryptedData)
							targetUrl.searchParams.set('from', 'clipboard')
							console.log('Encrypted credentials copied to clipboard for transfer.')
							window.location.href = targetUrl.href
							return
						}
						catch (e) {
							console.warn('Clipboard write failed, falling back to Catbox.', e)
						}

						// 2. Fallback to Catbox
						try {
							const fileId = await uploadToCatbox(encryptedData, '1h')
							targetUrl.searchParams.set('fileId', fileId)
							console.log(`Encrypted credentials uploaded to Catbox for transfer with fileId: ${fileId}`)
							window.location.href = targetUrl.href
							return
						}
						catch (catboxErr) {
							console.warn('Catbox upload failed, falling back to URL hash.', catboxErr)
						}

						// 3. Fallback to URL hash
						targetHashParams.set('encrypted_creds', encodeURIComponent(encryptedData))
						targetUrl.hash = targetHashParams.toString()
					}
					catch (encryptErr) {
						console.error('Failed to encrypt credentials for transfer:', encryptErr)
						// If encryption fails, we cannot proceed securely. Redirect without credentials.
					}

				window.location.href = targetUrl.href
			}
		})().catch(console.error)
	</script>
</head>

<body class="flex justify-center items-center h-screen">
	<span class="loading loading-ring loading-lg"></span>
</body>

</html>
