<!DOCTYPE html>
<html lang="${main_locale}">
${
	let messageHtml = setValue('messageHtml', await renderMarkdownAsStandAloneHtmlString(message.content_for_show || message.content))
	const tempDiv = document.createElement('div')
	tempDiv.innerHTML = messageHtml

	const rawText = tempDiv.textContent || tempDiv.innerText || ''
	const cleanText = rawText.replace(/\s+/g, ' ').trim()

	const h1 = tempDiv.querySelector('h1')
	setValue('pageTitle', h1 ? h1.textContent.trim() : (cleanText.substring(0, 30) + (cleanText.length > 30 ? '...' : '') || 'Chat Message'))

	setValue('pageDescription', cleanText.substring(0, 150) + (cleanText.length > 150 ? '...' : ''))
	''
}
<head>
	<meta charset="UTF-8">
	<meta name="darkreader-lock" />
	<meta property="og:title" content="${pageTitle.replace(/"/g, '&quot;')}" />
	<meta property="og:url" content="https://steve02081504.github.io/fount/protocol?url=fount://page/shells/chat/" />
	<meta property="og:type" content="website" />
	<meta property="og:description" content="${pageDescription.replace(/"/g, '&quot;')}" />
	<meta name="description" content="${pageDescription.replace(/"/g, '&quot;')}" />
	<meta property="og:image" content="https://repository-images.githubusercontent.com/862251163/0ac90205-ae40-4fc6-af67-1e28d074c76b" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>${pageTitle.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</title>
	<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4" crossorigin="anonymous"></script>
	<link href="https://cdn.jsdelivr.net/npm/daisyui/daisyui.css" rel="stylesheet" type="text/css" crossorigin="anonymous" />${messageHtml.includes('katex-mathml') ? `
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css" crossorigin="anonymous">` : ''}
	<style>
		body {
			margin: 0;
			font-family: sans-serif;
		}

		.markdown-body {
			box-sizing: border-box;
			padding: 45px;
		}

		.markdown-body .join-item, ${ messageHtml.includes('figure') ? `
		.markdown-body figure,` : '' }${messageHtml.includes('markdown-code-block') ? `
		.markdown-code-block,
		.markdown-code-block pre` : ''} {
			margin: 0 !important;
		}

		@media (max-width: 767px) {
			.markdown-body {
				padding: 15px;
			}
		}

		.text-icon {
			color: var(--color-base-content);
		}${messageHtml.includes('markdown-code-block') ? `\

		/* Styles for rehype-pretty-code (Shiki) */
		pre[style*="--shiki-light-bg"] {
			background-color: var(--shiki-light-bg);
		}

		[color-scheme="dark"] pre[style*="--shiki-dark-bg"] {
			background-color: var(--shiki-dark-bg);
		}

		[style*="--shiki-light"][style*="--shiki-dark"] {
			color: var(--shiki-light);
		}

		[color-scheme="dark"] [style*="--shiki-light"][style*="--shiki-dark"] {
			color: var(--shiki-dark);
		}` : ''}
	</style>
</head>

<body class="flex flex-col min-h-screen">
	<script>
		const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
		const styleLink = document.createElement('link')
		styleLink.rel = 'stylesheet'
		styleLink.crossOrigin = 'anonymous'
		document.documentElement.setAttribute('color-scheme', document.documentElement.dataset.theme = isDarkMode ? 'dark' : 'light')
		styleLink.href = `https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown-${'${isDarkMode ? \'dark\' : \'light\'}'}.min.css`
		document.head.appendChild(styleLink)
${ message.files?.length ? `
		/**
		 * æ‰“å¼€ä¸€ä¸ªæ¨¡æ€æ¡†ä»¥æ˜¾ç¤ºå›¾ç‰‡æˆ–è§†é¢‘ã€‚
		 * @param {string} src - åª’ä½“æ–‡ä»¶çš„æº URLã€‚
		 * @param {string} type - åª’ä½“æ–‡ä»¶çš„ç±»åž‹ ('image' æˆ– 'video')ã€‚
		 */
		function openModal(src, type) {
			const modal = document.createElement('div')
			modal.style.position = 'fixed'
			modal.style.top = '0'
			modal.style.left = '0'
			modal.style.width = '100%'
			modal.style.height = '100%'
			modal.style.backgroundColor = 'rgba(0,0,0,0.8)'
			modal.style.display = 'flex'
			modal.style.justifyContent = 'center'
			modal.style.alignItems = 'center'
			modal.style.zIndex = '1000'
			/**
			 * ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯æ—¶å…³é—­æ¨¡æ€æ¡†ã€‚
			 * @param {MouseEvent} e - ç‚¹å‡»äº‹ä»¶å¯¹è±¡ã€‚
			 */
			modal.onclick = (e) => {
				if (e.target !== modal) return
				const video = modal.querySelector('video')
				if (video) video.pause()
				modal.remove()
			}

			let contentElement
			if (type === 'image') {
				contentElement = document.createElement('img')
				contentElement.src = src
			} else if (type === 'video') {
				contentElement = document.createElement('video')
				contentElement.src = src
				contentElement.controls = true
				contentElement.autoplay = true
			}

			if (contentElement) {
				contentElement.style.maxWidth = '90%'
				contentElement.style.maxHeight = '90%'
				contentElement.style.objectFit = 'contain'
				modal.appendChild(contentElement)
			}

			document.body.appendChild(modal)
		}
` : ''}	</script>
	<main class="flex-grow markdown-body">
		${messageHtml}${
			if (!message.files?.length) return ''

			const attachmentItems = await Promise.all(message.files.map(async (file) => {
				let fileBuffer = file.buffer
				if (fileBuffer.startsWith('file:')) {
					const fileArrayBuffer = await getfile(fileBuffer)
					fileBuffer = arrayBufferToBase64(fileArrayBuffer)
				}
				const dataUrl = `data:${file.mime_type};base64,${fileBuffer}`

				let previewHtml = ''
				if (file.mime_type.startsWith('image/'))
					previewHtml = /*html*/ `<img src="${dataUrl}" alt="${file.name}" style="max-width: 100%; max-height: 100%; object-fit: contain; cursor: zoom-in;" onclick="openModal('${dataUrl}', 'image')">`
				else if (file.mime_type.startsWith('video/'))
					previewHtml = /*html*/ `<video src="${dataUrl}" controls style="max-width: 100%; max-height: 100%;"></video>`
				else if (file.mime_type.startsWith('audio/'))
					previewHtml = /*html*/ `<audio src="${dataUrl}" controls></audio>`
				else
					previewHtml = /*html*/ '<div class="file-placeholder" style="font-size: 40px; text-align: center;">ðŸ“„</div>'

				return /*html*/ `
			<div class="attachment" style="border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin: 5px; display: inline-block; text-align: center; max-width: 200px;">
				<div class="preview" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
					${previewHtml}
				</div>
				<div class="file-name" style="font-size: 0.8em; margin-top: 5px; word-wrap: break-word;">${file.name}</div>
				<a href="${dataUrl}" download="${file.name}" class="download-button" style="margin-top: 5px; display: inline-block; padding: 5px 10px; background-color: #007bff; color: white; text-decoration: none; border-radius: 3px;">${geti18n('chat.attachment.buttons.download.title') || 'Download'}</a>
			</div>
			`
			}))

			`<div class="attachments" style="margin-top: 10px; display: flex; flex-wrap: wrap;">${attachmentItems.join('')}</div>`
		}
	</main>
	<footer class="w-full text-center text-xs text-gray-500 p-4">
		<p>Generated by <a class="link" href="https://github.com/steve02081504/fount" target="_blank">fount</a></p>
	</footer>
</body>

</html>
