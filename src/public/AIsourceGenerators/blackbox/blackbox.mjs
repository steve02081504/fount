import axios from 'npm:axios'

/**
 * 用于与 Blackbox.ai API 交互的 BlackboxAI 类。
 */
export class BlackboxAI {
	/**
	 * 创建 BlackboxAI 的实例。
	 * @param {object} config - 配置对象。
	 */
	constructor(config) {
		this.apiUrl = 'https://api.blackbox.ai/api/chat'
		this.headers = {
			'Content-Type': 'application/json',
		}
		this.config = config
		this.conversationHistory = {}
		this.defaultModel = 'blackboxai'
	}

	/**
	 * 向 Blackbox.ai API 发送请求。
	 * @param {Array<object>} messages - 消息对象数组。
	 * @param {string} model - 用于请求的模型。
	 * @param {boolean} use_stream - 是否使用流式传输。
	 * @param {Function} [onProgress] - 进度回调函数。
	 * @param {AbortSignal} [signal] - 中断信号。
	 * @returns {Promise<string>} API 的响应。
	 */
	async call(messages, model, use_stream = false, onProgress, signal) {
		const payload = {
			messages,
			id: Date.now().toString(),
			previewToken: null,
			userId: null,
			codeModelMode: true,
			agentMode: {},
			trendingAgentMode: {},
			isMicMode: false,
			userSystemPrompt: null,
			maxTokens: 1024,
			playgroundTopP: 0.9,
			playgroundTemperature: 0.5,
			isChromeExt: false,
			githubToken: null,
			clickedAnswer2: false,
			clickedAnswer3: false,
			clickedForceWebSearch: false,
			visitFromDelta: false,
			mobileClient: false,
			userSelectedModel: model || this.defaultModel,
			stream: use_stream,
		}

		try {
			const response = await axios.post(this.apiUrl, payload, {
				headers: this.headers,
				responseType: use_stream ? 'stream' : 'json',
				signal,
			})

			if (use_stream)
				return new Promise((resolve, reject) => {
					let fullText = ''
					const stream = response.data
					stream.on('data', chunk => {
						const text = chunk.toString()
						fullText += text
						if (onProgress)
							onProgress(text)
					})
					stream.on('end', () => resolve(fullText.replace(/\n*generated by blackbox\.ai, try unlimited chat https:\/\/www\.blackbox\.ai\/?\n*/gi, '')))
					stream.on('error', err => reject(err))
				})

			else
				return response.data.replace(/\n*generated by blackbox\.ai, try unlimited chat https:\/\/www\.blackbox\.ai\/?\n*/gi, '')
		}
		catch (error) {
			console.error('Error communicating with Blackbox.ai:', error)
			throw error
		}
	}

	/**
	 * 计算给定文本中的令牌数。
	 * @param {string} text - 要计算令牌数的文本。
	 * @returns {Promise<number>} 令牌数。
	 */
	async countTokens(text) {
		const payload = {
			text
		}

		try {
			const response = await axios.post('https://api.blackbox.ai/api/token-count', payload, { headers: this.headers })
			return response.data.tokenCount
		}
		catch (error) {
			console.error('Error communicating with Blackbox.ai:', error)
			throw error
		}
	}
}
